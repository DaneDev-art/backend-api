name: Deploy to VPS (Zero Downtime)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: 89.167.71.3
          username: admin
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            echo "ğŸ”¹ DÃ©but du dÃ©ploiement..."
            cd ~/backend-api || exit 1

            echo "ğŸ”¹ Sauvegarde temporaire du serveur..."
            tar czf backup_$(date +%Y%m%d_%H%M%S).tar.gz . || echo "Ã‰chec de la sauvegarde, on continue"

            echo "ğŸ”¹ RÃ©cupÃ©ration des derniÃ¨res modifications..."
            git fetch origin main
            git reset --hard origin/main

            echo "ğŸ”¹ Installation des dÃ©pendances..."
            npm install --omit=dev

            echo "ğŸ”¹ DÃ©marrage temporaire sur un port secondaire..."
            TEMP_PORT=5001
            pm2 start server.js --name backend-temp -- --port $TEMP_PORT

            echo "ğŸ”¹ VÃ©rification que le serveur temporaire Ã©coute..."
            for i in {1..10}; do
              nc -z localhost $TEMP_PORT && echo "âœ… Serveur temporaire actif sur $TEMP_PORT" && break
              echo "â³ En attente du serveur temporaire..."
              sleep 3
            done

            nc -z localhost $TEMP_PORT || (echo "âŒ Le serveur temporaire ne rÃ©pond pas" && pm2 delete backend-temp && exit 1)

            echo "ğŸ”¹ Remplacement du serveur en production..."
            pm2 delete backend-api || echo "Pas de serveur existant"
            pm2 start server.js --name backend-api --update-env
            pm2 delete backend-temp
            pm2 save

            echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s et zÃ©ro downtime."
