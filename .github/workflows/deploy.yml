name: Deploy to VPS (Zero Downtime)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: 89.167.71.3
          username: admin
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e

            echo "ğŸ”¹ DÃ©but du dÃ©ploiement..."
            cd ~/backend-api || exit 1

            echo "ğŸ”¹ Sauvegarde temporaire..."
            tar czf backup_$(date +%Y%m%d_%H%M%S).tar.gz . || echo "âš ï¸ Sauvegarde Ã©chouÃ©e, on continue"

            echo "ğŸ”¹ RÃ©cupÃ©ration du code depuis GitHub..."
            git fetch origin main
            git reset --hard origin/main

            echo "ğŸ”¹ Installation des dÃ©pendances..."
            npm install --omit=dev

            echo "ğŸ”¹ DÃ©marrage serveur temporaire..."
            TEMP_PORT=5001
            PORT=$TEMP_PORT pm2 start server.js --name backend-temp --update-env

            echo "ğŸ”¹ Attente du dÃ©marrage..."
            sleep 5

            echo "ğŸ”¹ VÃ©rification du serveur temporaire..."
            if nc -z localhost $TEMP_PORT; then
              echo "âœ… Serveur temporaire actif sur port $TEMP_PORT"

              echo "ğŸ”¹ Remplacement du serveur production..."
              pm2 delete backend-api || echo "âš ï¸ Aucun serveur backend-api existant"

              PORT=5000 pm2 start server.js --name backend-api --update-env

              echo "ğŸ”¹ Suppression du serveur temporaire..."
              pm2 delete backend-temp

              echo "ğŸ”¹ Sauvegarde PM2..."
              pm2 save

              echo "âœ… DÃ©ploiement terminÃ© avec succÃ¨s (Zero Downtime)"
            else
              echo "âŒ Le serveur temporaire ne rÃ©pond pas"
              pm2 delete backend-temp || true
              exit 1
            fi
